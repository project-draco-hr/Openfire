{
  if (message != null) {
    JID recipientJID=message.getTo();
    if (recipientJID == null || serverAddress.equals(recipientJID) || recipientJID.getNode() == null || !UserManager.getInstance().isRegisteredUser(recipientJID.getNode())) {
      return;
    }
    if (Message.Type.groupchat == message.getType() || Message.Type.error == message.getType() || Message.Type.headline == message.getType()) {
      return;
    }
    PrivacyList list=PrivacyListManager.getInstance().getDefaultPrivacyList(recipientJID.getNode());
    if (list != null && list.shouldBlockPacket(message)) {
      Message result=message.createCopy();
      result.setTo(message.getFrom());
      result.setError(PacketError.Condition.service_unavailable);
      XMPPServer.getInstance().getRoutingTable().routePacket(message.getFrom(),result,true);
      return;
    }
    if (type == Type.bounce) {
      bounce(message);
    }
 else     if (type == Type.store) {
      store(message);
    }
 else     if (type == Type.store_and_bounce) {
      if (underQuota(message)) {
        store(message);
      }
 else {
        bounce(message);
      }
    }
 else     if (type == Type.store_and_drop) {
      if (underQuota(message)) {
        store(message);
      }
    }
  }
}
