{
  HttpConnection connection=new HttpConnection(rid,isSecure,sslCertificates);
  if (rid <= lastRequestID) {
    Delivered deliverable=retrieveDeliverable(rid);
    if (deliverable == null) {
      Log.warn("Deliverable unavailable for " + rid);
      throw new HttpBindException("Unexpected RID error.",BoshBindingError.itemNotFound);
    }
    connection.deliverBody(createDeliverable(deliverable.deliverables));
    addConnection(connection,isPoll);
    return connection;
  }
 else   if (rid > (lastRequestID + maxRequests)) {
    Log.warn("Request " + rid + " > "+ (lastRequestID + maxRequests)+ ", ending session.");
    throw new HttpBindException("Unexpected RID error.",BoshBindingError.itemNotFound);
  }
  if (packetsToBeSent.size() > 0) {
    packetsToSend.add(packetsToBeSent);
  }
  addConnection(connection,isPoll);
  return connection;
}
