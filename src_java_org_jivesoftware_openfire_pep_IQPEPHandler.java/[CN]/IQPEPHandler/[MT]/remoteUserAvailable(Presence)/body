{
  if (!isEnabled()) {
    return;
  }
  JID jidFrom=presence.getFrom();
  JID jidTo=presence.getTo();
  Set<JID> remotePresenceSet=knownRemotePresences.get(jidTo.toBareJID());
  if (jidFrom.getResource() != null) {
    if (remotePresenceSet != null) {
      remotePresenceSet.add(jidFrom);
    }
 else {
      remotePresenceSet=new HashSet<JID>();
      remotePresenceSet.add(jidFrom);
      knownRemotePresences.put(jidTo.toBareJID(),remotePresenceSet);
    }
    PEPService pepService=pepServiceManager.getPEPService(jidTo.toBareJID());
    if (pepService != null) {
      pepService.sendLastPublishedItems(jidFrom);
    }
  }
}
