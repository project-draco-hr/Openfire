{
synchronized (this) {
    if (running) {
      return;
    }
    running=true;
  }
  try {
    running=true;
    String pluginDirs=System.getProperty("pluginDirs");
    if (pluginDirs != null) {
      StringTokenizer st=new StringTokenizer(pluginDirs,", ");
      while (st.hasMoreTokens()) {
        String dir=st.nextToken();
        if (!devPlugins.contains(dir)) {
          loadPlugin(new File(dir));
          devPlugins.add(dir);
        }
      }
    }
    File[] jars=pluginDirectory.listFiles(new FileFilter(){
      @Override public boolean accept(      File pathname){
        String fileName=pathname.getName().toLowerCase();
        return (fileName.endsWith(".jar") || fileName.endsWith(".war"));
      }
    }
);
    if (jars == null) {
      return;
    }
    for (    File jarFile : jars) {
      String pluginName=jarFile.getName().substring(0,jarFile.getName().length() - 4).toLowerCase();
      File dir=new File(pluginDirectory,pluginName);
      pluginFiles.put(pluginName,jarFile);
      if (!dir.exists()) {
        unzipPlugin(pluginName,jarFile,dir);
      }
 else       if (jarFile.lastModified() > dir.lastModified()) {
        if (firstRun) {
          int count=0;
          while (!deleteDir(dir) && count++ < 5) {
            Thread.sleep(1000);
          }
        }
 else {
          unloadPlugin(pluginName);
        }
        if (!dir.exists()) {
          unzipPlugin(pluginName,jarFile,dir);
        }
      }
    }
    File[] dirs=pluginDirectory.listFiles(new FileFilter(){
      @Override public boolean accept(      File pathname){
        return pathname.isDirectory();
      }
    }
);
    Arrays.sort(dirs,new Comparator<File>(){
      @Override public int compare(      File file1,      File file2){
        if (file1.getName().equals("admin")) {
          return -1;
        }
 else         if (file2.getName().equals("admin")) {
          return 1;
        }
 else {
          return file1.compareTo(file2);
        }
      }
    }
);
    Set<String> jarSet=new HashSet<>();
    for (    File file : jars) {
      jarSet.add(file.getName().toLowerCase());
    }
    List<String> toDelete=new ArrayList<>();
    for (    File pluginDir : dirs) {
      String pluginName=pluginDir.getName();
      if (pluginName.equals("admin")) {
        continue;
      }
      if (!jarSet.contains(pluginName + ".jar")) {
        if (!jarSet.contains(pluginName + ".war")) {
          toDelete.add(pluginName);
        }
      }
    }
    for (    String pluginName : toDelete) {
      unloadPlugin(pluginName);
    }
    for (    File dirFile : dirs) {
      if (dirFile.exists() && !plugins.containsKey(dirFile.getName())) {
        loadPlugin(dirFile);
      }
    }
    if (!XMPPServer.getInstance().isSetupMode()) {
      executed=true;
    }
    firePluginsMonitored();
  }
 catch (  Throwable e) {
    Log.error(e.getMessage(),e);
  }
synchronized (this) {
    running=false;
  }
  firstRun=false;
}
