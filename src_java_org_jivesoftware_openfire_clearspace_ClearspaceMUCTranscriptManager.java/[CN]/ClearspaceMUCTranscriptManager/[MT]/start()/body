{
  MUCEventDispatcher.addListener(this);
  transcriptUpdateTask=new TimerTask(){
    @Override public void run(){
      if (roomEvents.isEmpty()) {
        return;
      }
      Set<String> presenceRoomJids=new HashSet<String>();
      IQ packet=new IQ();
      packet.setTo(csComponentAddress);
      packet.setFrom(csMucDomain);
      packet.setType(IQ.Type.set);
      Element transcriptElement=packet.setChildElement("transcript-update","http://jivesoftware.com/clearspace");
      for (      ClearspaceMUCTranscriptEvent event : roomEvents) {
        Element mucEventElement=null;
switch (event.type) {
case messageReceived:
          mucEventElement=transcriptElement.addElement("message");
        mucEventElement.addElement("body").setText(event.content);
      break;
case occupantJoined:
    mucEventElement=transcriptElement.addElement("presence");
  presenceRoomJids.add(event.roomJID.toBareJID());
break;
case occupantLeft:
mucEventElement=transcriptElement.addElement("presence");
mucEventElement.addAttribute("type","unavailable");
presenceRoomJids.add(event.roomJID.toBareJID());
break;
case roomSubjectChanged:
mucEventElement=transcriptElement.addElement("subject-change");
mucEventElement.addElement("subject").setText(event.content);
break;
}
if (mucEventElement != null) {
if (event.user != null) {
mucEventElement.addAttribute("from",event.user.toBareJID());
}
if (event.roomJID != null) {
mucEventElement.addElement("roomjid").setText(event.roomJID.toBareJID());
}
mucEventElement.addElement("timestamp").setText(Long.toString(event.timestamp));
}
}
MultiUserChatManager mucManager=XMPPServer.getInstance().getMultiUserChatManager();
for (String roomJid : presenceRoomJids) {
JID jid=new JID(roomJid);
MultiUserChatService mucService=mucManager.getMultiUserChatService(jid);
MUCRoom room=mucService.getChatRoom(jid.getNode());
int totalOccupants=room.getOccupantsCount();
for (JID owner : room.getOwners()) {
try {
if (!room.getOccupantsByBareJID(owner).isEmpty()) {
totalOccupants--;
}
}
 catch (UserNotFoundException e) {
}
}
Element occUpdateElement=transcriptElement.addElement("occupant-count-update");
occUpdateElement.addElement("roomjid").setText(roomJid);
occUpdateElement.addElement("count").setText(Integer.toString(totalOccupants));
}
IQ result=ClearspaceManager.getInstance().query(packet,15000);
if (result == null) {
Log.warn("Did not get a reply from sending a transcript-update packet to Clearspace.");
return;
}
 else if (result.getType() == IQ.Type.error) {
Log.warn("Clearspace received a transcript-update packet but was not able to process it." + result.toXML());
return;
}
roomEvents.clear();
}
}
;
taskEngine.schedule(transcriptUpdateTask,FLUSH_PERIOD,FLUSH_PERIOD);
}
